import pandas as pd

# Load your data
file_path = "your_file.csv"
df = pd.read_csv(file_path)

# Step 1: Define a function to assign positive or negative sign based on the 'Direction' column
def apply_sign(row):
    if row['Direction'] == 'DEL':
        return row['Amount USD']
    elif row['Direction'] == 'REC':
        return -row['Amount USD']
    else:
        return 0

# Step 2: Apply the function to create a new column 'Signed Amount USD'
df['Signed Amount USD'] = df.apply(apply_sign, axis=1)

# Step 3: Group by 'Unique' and sum up the 'Signed Amount USD' for each 'Unique' to get the original net values
original_netting_opportunities = df.groupby('Unique')['Signed Amount USD'].sum().reset_index()
original_netting_opportunities.columns = ['Unique', 'Original Netting Opportunity USD']

# Step 4: Scenario Adjustments - Define different scenarios
# Example: Adjusting Amount USD for specific currency or transaction type

# Scenario 1: Increase 'Amount USD' by 10% for all EUR transactions
df['Scenario 1 Amount USD'] = df.apply(lambda row: row['Amount USD'] * 1.10 if row['Currency'] == 'EUR' else row['Amount USD'], axis=1)
df['Scenario 1 Signed Amount USD'] = df.apply(lambda row: row['Scenario 1 Amount USD'] if row['Direction'] == 'DEL' else -row['Scenario 1 Amount USD'], axis=1)

# Scenario 2: Decrease 'Amount USD' by 5% for all BUY transactions
df['Scenario 2 Amount USD'] = df.apply(lambda row: row['Amount USD'] * 0.95 if row['Transaction Type'] == 'BUY' else row['Amount USD'], axis=1)
df['Scenario 2 Signed Amount USD'] = df.apply(lambda row: row['Scenario 2 Amount USD'] if row['Direction'] == 'DEL' else -row['Scenario 2 Amount USD'], axis=1)

# Step 5: Calculate netting opportunities for each scenario

# Scenario 1 netting opportunities
scenario_1_netting_opportunities = df.groupby('Unique')['Scenario 1 Signed Amount USD'].sum().reset_index()
scenario_1_netting_opportunities.columns = ['Unique', 'Scenario 1 Netting Opportunity USD']

# Scenario 2 netting opportunities
scenario_2_netting_opportunities = df.groupby('Unique')['Scenario 2 Signed Amount USD'].sum().reset_index()
scenario_2_netting_opportunities.columns = ['Unique', 'Scenario 2 Netting Opportunity USD']

# Step 6: Merge the results to compare the original and scenario netting opportunities
comparison = original_netting_opportunities.merge(scenario_1_netting_opportunities, on='Unique', how='left')
comparison = comparison.merge(scenario_2_netting_opportunities, on='Unique', how='left')

# Step 7: Display the comparison
print("Comparison of Original and Scenario Netting Opportunities:")
print(comparison)

# Step 8: Optionally, save the comparison to a CSV file for further analysis
comparison.to_csv('netting_opportunities_scenario_comparison.csv', index=False)
